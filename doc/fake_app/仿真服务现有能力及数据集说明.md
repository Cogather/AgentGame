# 租房仿真与评测说明（完整版）

本文档主要说明四件事：
- **fake_app 仿真服务是做什么的**（见第一节）
- **租房数据集是怎么构造的**（见第二节）
- **评测案例（赛题场景）覆盖哪些**（见第三节）
- **评测数据集是怎么构造的**（见第四节）

---

## 一、fake_app 仿真服务介绍

### 1.1 是什么

**fake_app** 是支撑 Agent **比赛**的仿真租房后端服务（赛题环境 + 评测）。不连接真实房产平台，在内存中加载本地 JSON 数据，对外提供与真实租房查询、状态管理一致的 **HTTP API**，供参赛 Agent 及评测脚本调用。

- **作用**：赛题环境（查房源、筛选、详情、地标、预约、租赁/退租等完整任务）+ 评测：① 评判参赛 Agent，支撑比赛；② 调 fake_app 接口构造完整评测集（初始评测集仅有 message、接口、案例等，无具体 house 数据，需实际调接口后补充）。
- **特点**：数据只读加载、按用户隔离状态（多用户租赁/退租互不影响）。

### 1.2 能力概览

| 能力 | 说明 |
|------|------|
| **房源检索** | 多条件筛选（区域、预算、户型、地铁、装修、朝向、电梯、面积、可入住日期、到西二旗通勤等）、排序、分页 |
| **房源详情** | 按 house_id 查单套房源，含地铁、通勤、隐性属性（如噪音等级） |
| **按小区查** | 按小区名查该小区可租房源，支撑指代（如「建清园那套」）、在租状态、地铁信息、隐性属性 |
| **地标附近房** | 按地标 ID/名称 + 距离上限，查该地标周边的可租房源，返回带距离与步行时间 |
| **小区周边地标** | 按小区名 + 类型（商超/公园）+ 距离上限，查该小区周边的商场、公园等，返回带距离 |
| **房源统计** | 总套数、按状态/行政区/户型分布、价格区间 |
| **状态更新（按用户）** | 租赁、退租、下架：更新**当前用户**视角下某房源状态（available/rented/offline），其他用户不受影响 |

### 1.3 用户隔离（多用户互不影响）

- 请求头 **X-User-ID** 标识当前用户，**所有房源相关接口均必填**。不带头时接口返回 400，提示「请提供请求头 X-User-ID 以标识当前用户」。带该头时，列表/详情/统计/按小区/附近房等按**该用户视角**返回（基础数据 + 该用户的内存状态覆盖）；PUT 更新该用户视角下的状态。

### 1.4 主要接口一览

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | /api/landmarks | 全部地标，可选 category（subway/company/landmark）、district 筛选（不需 X-User-ID） |
| GET | /api/landmarks/name/{name} | 按名称精确查地标（如西二旗站、百度）（不需 X-User-ID） |
| GET | /api/landmarks/search | 关键词模糊搜索，q 必填、category 可选（不需 X-User-ID） |
| GET | /api/landmarks/{id} | 按 id 查地标详情（不需 X-User-ID） |
| GET | /api/landmarks/stats | 地标统计（不需 X-User-ID） |
| GET | /api/houses | 多条件筛选、排序、分页（**必带 X-User-ID**） |
| GET | /api/houses/{house_id} | 单套房源详情（**必带 X-User-ID**） |
| GET | /api/houses/by_community | 按小区名查可租房源（**必带 X-User-ID**） |
| GET | /api/houses/nearby | 地标附近房源（landmark_id + max_distance，**必带 X-User-ID**） |
| GET | /api/houses/nearby_landmarks | 某小区周边商超/公园（**必带 X-User-ID**） |
| GET | /api/houses/stats | 房源统计（**必带 X-User-ID**） |
| PUT/PATCH | /api/houses/{house_id}/status | 更新当前用户视角下该房源状态（**必带 X-User-ID**），请求体如 `{"status":"rented"}`；响应 data 为修改后的房源完整对象 |
| POST | /api/houses/init | **初始化指定用户的房源数据**：清空该用户的状态覆盖，该用户视角恢复为初始状态；**必带 X-User-ID** 指定要重置的用户。<font color='blue'>**评测/比赛每启动新题目时对该用户调用，保证可以多次重做题目**</font>。 |

### 1.5 数据从哪里来

- **房源**：从 `fake_app/data` 目录下的 **database_数字.json**（如 database_2000.json、database_4000.json）按数字升序合并加载，同 house_id 时后加载覆盖先加载的。房源数据构造时依赖地标文件（subway_stations、landmarks、fortune500 等）确定数据集范围（见第二节）。

---

## 二、租房数据集介绍

### 2.1 是什么

**租房数据集** 指供 fake_app 加载的、符合约定结构的**房源 JSON 文件**：

- **房源**：`database_2000.json`（及可选的 database_4000、6000、8000、10000），每文件最多 2000 条，格式为 `{"houses": [ {...}, ... ]}`。

仿真服务只支撑「检索、推荐、地铁/通勤、可入住时间、在租/预约、隐性属性解释、周边商超/公园」，不支撑合同解读、成本明细、周边医院/学校等。

### 2.2 单条房源结构（构造标准）

单条房源需包含以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| house_id | string | 房源唯一标识，如 HF_1 |
| community, district, area, address | string | 小区名、行政区、商圈、详细地址 |
| bedrooms, livingrooms, bathrooms | int | 卧室、客厅、卫生间数 |
| area_sqm | number | 面积（平米） |
| floor, total_floors | string/int | 楼层描述、总楼层 |
| orientation, decoration | string | 朝向、装修（如精装/简装） |
| price, price_unit | int, string | 月租金（元）、单位（元/月） |
| rental_type, property_type, utilities_type | string | 整租/合租、物业类型、水电类型（民水民电等） |
| elevator | bool | 是否有电梯 |
| subway, subway_station, subway_distance | string, string, int | 地铁线路、站名、距地铁距离（米） |
| commute_to_xierqi | int | 到西二旗通勤时间（分钟） |
| available_from | string | 可入住日期，如 2026-03-01 |
| listing_platform, listing_url | string | 挂牌平台、链接 |
| tags | []string | 标签（如近地铁、精装修） |
| hidden_noise_level | string | 隐性噪音水平：安静/中等/吵闹/临街 |
| status | string | available（可租）/ rented（已租）/ offline（下架） |
| longitude, latitude, coordinate_system | number, number, string | 经纬度（WGS84）、坐标系 |

通勤策略为**仅支持到西二旗**（commute_to_xierqi），不做其他地标通勤泛化。

### 2.3 租房数据集是如何构造出来的

房源数据由脚本 **generate_houses.py**（路径：`AgentGame/fake_app/py/generate_houses.py`）按**数据分布规则**生成，保证数据可支撑评测中的各类筛选与场景。

**依赖地标确定范围**（脚本会读取）：

- `fake_app/data` 下的 **subway_stations.json**、**landmarks.json**、**fortune500_companies.json** 作为「地标种子」：房源数据集的行政区、商圈、地铁站、经纬度等范围由这些地标决定，保证与地标一致、可查。

**生成与追加规则**：

- **条数**：通过命令行参数指定，如 `python generate_houses.py 2000`；支持多次追加，脚本会先扫描已有 database_2000/4000/… 等文件，合并为「全量已有条数」再生成新一批。
- **分文件**：按 2000 条一个文件写入；先写满 database_2000.json，再 database_4000、6000、8000、10000，避免单文件过大。
- **覆盖均衡**：所有「轮换」维度（地标种子、地铁距离段、装修、朝向、整租/合租、噪音、状态等）都基于 **index_for_coverage = 已有条数 + 本次序号**，因此追加多次后全量数据仍按规则均衡分布。

**主要分布规则摘要**：

| 维度 | 规则摘要 |
|------|----------|
| 地标/行政区/地铁站 | 由 subway_stations + landmarks + fortune500 合并为 seeds，按 index 轮换选取种子 |
| 地铁距离 | 5 段（约 200–500 / 500–1000 / … / 3500–5500 米），按 index 轮换，并与价格系数挂钩 |
| 装修 | 简装约 32%、精装约 44%、豪华约 12%、毛坯约 8%、空房约 4% |
| 整租/合租 | 约 50% : 50% |
| 朝向 | 朝南/朝北/朝东/朝西/南北/东西 六种均分 |
| 状态 | 约 90% available、约 5% rented、约 5% offline（下架） |
| 价格 | 由行政区基准单价 × 面积 × 装修/地铁/电梯/楼层系数 × (1±6% 随机)，截断到 800～28000 元/月 |
| 小区名 | 前缀+后缀组合，且不与已有 used_communities 重复 |
| 通勤 | 由房源与西二旗站坐标用 Haversine 算距离，再换算为分钟（commute_to_xierqi） |

地标文件为预先准备，脚本只生成房源，并保证房源坐标、地铁站名、行政区等与地标范围一致。

---

## 三、评测案例场景介绍

**评测（评判）用法**：按案例逐轮向 Agent 输入 user_input → Agent 调用 fake_app 完成任务 → 评测端用案例中已有的 expected_message_contains、expected_tool_calls、response.houses 与 Agent 实际回复、实际工具调用及返回结果比对，**无需评测时再调接口**，结果一致即可判分。

- **重做与初始化**：为保证**同一题目可以多次重做**，评测或比赛在**每启动一道新题**（或开始/重做某条案例）前，应对该用户调用 **POST /api/houses/init**（必带 X-User-ID），清空该用户的状态覆盖，使该用户视角恢复为初始状态，这样每次重做时房源状态与案例期望一致。

### 3.1 评测案例集是什么

**评测案例集** 是一份结构化的 **JSON 案例定义**，用于描述「用户说什么、期望 Agent 做什么、依赖哪些数据与接口 以及 期望结果」。评测相关有两个核心文件：

| 文件 | 路径 | 说明 |
|------|------|------|
| **case_init.json** | `AgentGame/fake_app/data/case_init.json` | **初始评测集框架**，人工维护。根结构为 `test_suite`、`version`、`description`、**cases**（案例数组）；每轮含 user_input、response（message、**houses 为空**）、expected_tool_calls、expected_tool_inputs，不包含具体房源数据。用于定义「题目长什么样、期望调哪些接口、传什么参数」。 |
| **case_result.json** | `AgentGame/fake_app/data/case_result.json` | **完整评测集**。由脚本 **build_eval_dataset.py** 根据 case_init.json 调用 fake_app 接口后生成：每轮的 **response.houses** 已填为当轮查询返回的完整房源列表，题目、期望接口与期望房源均齐全，评测/比赛时**直接使用本文件**作为输入与标准答案，无需再调接口。|

### 3.2 单个评测案例的结构（构造标准）

以 **AgentGame/fake_app/data/case_init.json** 为准。经 **build_eval_dataset.py** 补充每轮 **response.houses** 后输出为 **case_result.json**（完整评测集），评测时直接使用该文件。

**案例级字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| case_id | string | 案例唯一标识，如 EV-01、EV-02、…、EV-40 |
| scenario_type | string | single（单轮）或 multi（多轮） |
| description | string | 案例简短说明 |
| rounds | array | 轮次数组，每轮结构见下表 |

**每轮（rounds[]）字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| session_id | string | 会话 ID，多轮同案例一般与 case_id 一致 |
| user_input | string | 用户当轮话术，评测时作为当轮题目输入 |
| response | object | 含 **message**（字符串）、**houses**（数组）。初始在 case_init 中为空；运行 **build_eval_dataset.py** 时，脚本根据本轮 expected_tool_calls/expected_tool_inputs 调用 fake_app 接口取返回值补充 houses |
| expected_tool_calls | array | 期望调用的接口路径列表，如 `["GET /api/houses"]` |
| expected_tool_inputs | array | 与接口对应的入参；列表/按小区等为 `[{ "query": { ... } }]`，query 键与 fake_app HTTP 参数一致（district、max_price、bedrooms、available_from_before 等） |
| expected_message_contains | string 或 null | 可选。若存在则用于比对 Agent 当轮回复是否包含期望内容 |

**说明**：评测时以每轮 **user_input** 作为输入，同一案例内按轮次依次输入、共享上下文，不同案例相互隔离。

### 3.3 评测案例覆盖哪些场景

评测案例模拟**用户找房时会遇到的典型场景**，大致分为以下几类：

| 场景类型 | 用户在做什么 / 案例在测什么 | 示例案例 |
|----------|-----------------------------|----------|
| **检索找房** | 按预算、区域、户型、面积、装修、朝向、地铁距离、通勤等条件筛选房源 | EV-01～EV-04、EV-06～EV-17、EV-19～EV-23、EV-27～EV-30 |
| **可入住时间** | 找「某日期前能入住」的房，或问「某套房什么时候能入住」 | EV-03、EV-28、EV-20 等 |
| **在租与预约** | 问某套还能不能约看房、确认看房时间等 | EV-05、EV-08、EV-15、EV-17、EV-18、EV-20 等 |
| **指代与细节** | 用「那套」「建清园那套」指代某套房，或问噪音等隐性信息 | EV-07、EV-08、EV-15、EV-17 等 |
| **周边配套** | 问离地铁多远、附近有没有商超/公园 | EV-24～EV-26、EV-27 等 |
| **租赁/退租** | 用户决定租或退租，Agent 需在系统里更新该房状态 | EV-30、EV-31、EV-32、EV-33、EV-34、EV-40 等 |


---

## 四、评测数据集是如何构造出来的

**完整评测集（case_result.json）怎么来：**

1. 人工维护好 **case_init.json**（只有题目和期望接口，没有具体房源）。
2. 启动 **fake_app** 服务接口（AgentGame），然后运行脚本 **build_eval_dataset.py**（默认读 case_init、写 case_result），脚本会按每轮「期望的接口」调 fake_app，把返回的房源填进每轮的 houses。
3. 得到的 **case_result.json** 就是完整评测集。

**新增或修改案例时**：改 case_init.json，再跑一遍脚本即可；可用 `--case-ids`、`--case-id-range` 只处理指定案例并合并回已有 case_result。脚本路径与参数见第五节索引。

---

## 五、文档与文件索引

| 内容 | 文档/文件 |
|------|-----------|
| fake_app 能力与接口设计 | AgentGame/doc/fake_app/house_rental_design.md、landmark_manager.md |
| 房源数据集生成脚本 | AgentGame/fake_app/py/generate_houses.py |
| 评测集初始结构（案例定义） | AgentGame/fake_app/data/case_init.json |
| 完整评测集（含 houses 数据） | AgentGame/fake_app/data/case_result.json |
| 完整评测集构造脚本（调接口补 houses） | AgentGame/fake_app/py/build_eval_dataset.py；默认输入 case_init.json、输出 case_result.json；支持 --case-ids / --case-id-range 仅处理指定案例 |
| Agent 可集成的仿真服务工具集说明（OpenAPI 3） | AgentGame/fake_app/data/fake_app_agent_tools.json |

---

*文档版本：v1.0 | 面向「租房仿真服务 + 租房数据集 + 评测案例 + 评测数据集」的完整用户说明*
